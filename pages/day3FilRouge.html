<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jour 3 ‚Äî Fil Rouge : D√©veloppement d'API REST Avanc√©</title>
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/day3FilRouge.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="../assets/logo.jpeg" alt="YNOV Campus" class="logo-img">
        <span class="logo-text">WebServices</span>
      </div>
      <ul class="nav-menu">
        <li class="nav-item"><a href="../index.html" class="nav-link">Accueil</a></li>
        <li class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle">
            <i class="fas fa-calendar-alt"></i> Journ√©es
            <i class="fas fa-chevron-down"></i>
          </a>
          <div class="dropdown-menu">
            <a href="day1.html" class="dropdown-item">Jour 1 - Th√©orie</a>
            <a href="day1FilRouge.html" class="dropdown-item">Jour 1 - Fil Rouge</a>
            <a href="day2.html" class="dropdown-item">Jour 2 - Th√©orie</a>
            <a href="day2FilRouge.html" class="dropdown-item">Jour 2 - Fil Rouge</a>
            <a href="day3.html" class="dropdown-item">Jour 3 - Th√©orie</a>
            <a href="day3FilRouge.html" class="dropdown-item">Jour 3 - Fil Rouge</a>
          </div>
        </li>
        <li class="nav-item"><a href="../index.html#projet" class="nav-link">Projet</a></li>
        <li class="nav-item"><a href="resources.html" class="nav-link">Ressources</a></li>
        <li class="nav-item"><a href="../index.html#contact" class="nav-link">Contact</a></li>
      </ul>
      <div class="hamburger">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero" style="min-height: 60vh;">
    <div class="container">
      <div class="hero-content">
        <div class="hero-text">
          <h1 class="hero-title">Jour 3 ‚Äî Fil Rouge</h1>
          <p class="hero-subtitle">Base de donn√©es & CRUD complet</p>
          <p class="hero-description">Connectez vos services √† de vraies bases de donn√©es et impl√©mentez le CRUD complet avec validation.</p>
          <div class="hero-buttons">
            <a href="day3.html" class="btn btn-secondary">
              <i class="fas fa-book"></i> Retour √† la th√©orie
            </a>
            <a href="../index.html#programme" class="btn btn-secondary"><i class="fas fa-arrow-left"></i>Retour au programme</a>
          </div>
        </div>
        <div class="hero-image-container">
          <img src="../assets/webservices.jpg" alt="Web Services" class="hero-image">
        </div>
      </div>
    </div>
  </section>

  <!-- Objectifs du Fil Rouge -->
  <section class="objectives">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">Objectifs du Fil Rouge J3</h2>
        <p class="section-subtitle">√Ä la fin de cette session, votre API SmartCity aura :</p>
      </div>
      <div class="objectives-grid">
        <div class="objective-card">
          <div class="objective-icon">
            <i class="fas fa-database"></i>
          </div>
          <h3>Base de donn√©es connect√©e</h3>
          <p>Sch√©ma/migrations cr√©√©s et endpoints CRUD complets</p>
        </div>
        <div class="objective-card">
          <div class="objective-icon">
            <i class="fas fa-shield-alt"></i>
          </div>
          <h3>Authentification r√©elle</h3>
          <p>Hash bcrypt et JWT sign√©s avec middleware exportable</p>
        </div>
        <div class="objective-card">
          <div class="objective-icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <h3>Validation compl√®te</h3>
          <p>Validation des donn√©es entrantes et tests d'int√©gration</p>
        </div>
        <div class="objective-card">
          <div class="objective-icon">
            <i class="fas fa-desktop"></i>
          </div>
          <h3>Frontend int√©gr√©</h3>
          <p>Formulaires fonctionnels et gestion des erreurs UI</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Contenu du Fil Rouge -->
  <section class="workshop-content">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">üöÄ PROJET FIL ROUGE - DEMI-JOURN√âE 3 (J3 Apr√®s-midi)</h2>
        <p class="section-subtitle">SmartCity API Platform - Base de donn√©es & CRUD complet</p>
        <p class="workshop-duration">Dur√©e : 3h30 (13h30-17h00)</p>
        <p class="workshop-context">Contexte : Ce matin vous avez vu le versioning d'API, la documentation OpenAPI et HATEOAS. Cet apr√®s-midi, vous allez connecter vos services √† de vraies bases de donn√©es et impl√©menter le CRUD complet avec validation.</p>
      </div>

      <!-- Rappel de la situation -->
      <div class="situation-recap">
        <h3>üìã RAPPEL DE VOTRE SITUATION (J2 ‚Üí J3)</h3>
        
        <div class="recap-grid">
          <div class="recap-card completed">
            <h4>‚úÖ Ce que vous avez (depuis J2)</h4>
            <ul>
              <li>Endpoints fonctionnels avec donn√©es en dur (tableaux)</li>
              <li>Pagination impl√©ment√©e (page/limit)</li>
              <li>Gestion d'erreurs RFC 7807 centralis√©e</li>
              <li>Headers de corr√©lation (X-Correlation-Id)</li>
              <li>3-5 tests unitaires qui passent</li>
              <li>Mock Prism g√©n√©r√© et accessible</li>
              <li>Front qui consomme les mocks Prism</li>
            </ul>
          </div>
          
          <div class="recap-card target">
            <h4>üéØ Ce qu'on vise aujourd'hui (r√©aliste pour 3h30)</h4>
            <p>√Ä 17h00, chaque √©quipe doit avoir :</p>
            
            <div class="team-goals">
              <h5>√âQUIPES BACK-END (sauf Auth) :</h5>
              <ul>
                <li>‚úÖ Base de donn√©es install√©e et configur√©e</li>
                <li>‚úÖ Sch√©ma/migrations cr√©√©s</li>
                <li>‚úÖ Endpoints CRUD complets (GET, POST, PUT, PATCH, DELETE)</li>
                <li>‚úÖ Validation des donn√©es entrantes (Joi/Zod/Pydantic)</li>
                <li>‚úÖ Tests d'int√©gration avec DB</li>
                <li>‚úÖ Remplacement des tableaux en m√©moire par requ√™tes DB</li>
              </ul>
              
              <h5>√âQUIPE AUTH :</h5>
              <ul>
                <li>‚úÖ Table users en base de donn√©es</li>
                <li>‚úÖ Hash bcrypt pour les mots de passe</li>
                <li>‚úÖ G√©n√©ration de vrais JWT sign√©s avec cl√© secr√®te</li>
                <li>‚úÖ V√©rification de tokens (middleware d'authentification)</li>
                <li>‚úÖ Tests avec utilisateurs r√©els en DB</li>
                <li>‚úÖ Middleware d'authentification exportable pour les autres √©quipes</li>
              </ul>
              
              <h5>√âQUIPE FRONT :</h5>
              <ul>
                <li>‚úÖ Basculer des mocks Prism vers les vrais services</li>
                <li>‚úÖ Formulaires de cr√©ation (POST) fonctionnels</li>
                <li>‚úÖ Gestion des erreurs de validation c√¥t√© UI</li>
                <li>‚úÖ Int√©gration avec Auth (login/register)</li>
                <li>‚úÖ Stockage du token (localStorage/sessionStorage)</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="not-expected">
          <h4>‚ùå CE QUI N'EST PAS ATTENDU AUJOURD'HUI</h4>
          <ul>
            <li>‚ùå Tests exhaustifs (J6-J7)</li>
            <li>‚ùå Cache Redis (J7)</li>
            <li>‚ùå API Gateway (J6)</li>
            <li>‚ùå Containerisation (J8)</li>
            <li>‚ùå CI/CD (J8)</li>
          </ul>
        </div>
      </div>

      <!-- Phase 1: Daily & Alignement -->
      <div class="phase-card">
        <div class="phase-header">
          <div class="phase-number">1</div>
          <div class="phase-info">
            <h3>üèÅ PHASE 1 : DAILY & ALIGNEMENT</h3>
            <p class="phase-duration">13h30-13h45 (15 min)</p>
          </div>
        </div>
        <div class="phase-content">
          <div class="phase-objectives">
            <h4>üìã Daily Stand-up par √©quipe (10 min)</h4>
            <p>Chaque √©quipe fait son stand-up interne :</p>
            <ul>
              <li>Ce qui a √©t√© fait depuis J2 (lectures, pr√©parations...)</li>
              <li>Blockers √©ventuels (installation DB, choix ORM...)</li>
              <li>Plan pour aujourd'hui</li>
            </ul>
          </div>
          
          <div class="phase-objectives">
            <h4>üîÑ Synchronisation inter-√©quipes (5 min)</h4>
            <p>Point rapide tous ensemble :</p>
            <ul>
              <li>Back : "Quelle base de donn√©es avez-vous choisie ?"</li>
              <li>Auth : "Format JWT finalis√© ? Middleware pr√™t ?"</li>
              <li>Front : "Pr√™t √† basculer vers les vrais services ?"</li>
            </ul>
          </div>
          
          <div class="convention-box">
            <h4>üåê Convention d'URLs mises √† jour :</h4>
            <pre><code class="text">AUTH      ‚Üí http://localhost:3001/api/v1
EVENTS    ‚Üí http://localhost:3002/api/v1
TRANSPORT ‚Üí http://localhost:3003/api/v1
SERVICE_3 ‚Üí http://localhost:3004/api/v1
SERVICE_4 ‚Üí http://localhost:3005/api/v1
FRONT     ‚Üí http://localhost:3000</code></pre>
          </div>
        </div>
      </div>

      <!-- Phase 2: Configuration Base de donn√©es -->
      <div class="phase-card">
        <div class="phase-header">
          <div class="phase-number">2</div>
          <div class="phase-info">
            <h3>üì¶ PHASE 2 : CONFIGURATION BASE DE DONN√âES</h3>
            <p class="phase-duration">13h45-14h30 (45 min)</p>
          </div>
        </div>
        <div class="phase-content">
          <div class="phase-objectives">
            <h4>A. Installation et configuration (20 min)</h4>
            
            <h5>Choix de base de donn√©es recommand√©s :</h5>
            <ul>
              <li><strong>PostgreSQL</strong> (recommand√©) : Robuste, ACID, JSON natif</li>
              <li><strong>MongoDB</strong> : Document-based, flexible</li>
              <li><strong>MySQL</strong> : Simple, largement utilis√©</li>
              <li><strong>SQLite</strong> : Pour d√©veloppement local uniquement</li>
            </ul>
            
            <h5>Installation rapide avec Docker :</h5>
            <div class="code-example">
              <pre><code class="bash"># PostgreSQL
docker run --name smartcity-postgres \
  -e POSTGRES_PASSWORD=secret \
  -e POSTGRES_DB=smartcity \
  -p 5432:5432 \
  -d postgres:15

# MongoDB
docker run --name smartcity-mongo \
  -p 27017:27017 \
  -d mongo:7

# MySQL
docker run --name smartcity-mysql \
  -e MYSQL_ROOT_PASSWORD=secret \
  -e MYSQL_DATABASE=smartcity \
  -p 3306:3306 \
  -d mysql:8.0</code></pre>
            </div>
          </div>
          
          <div class="phase-objectives">
            <h4>B. Configuration ORM/ODM (25 min)</h4>
            
            <h5>Node.js - Prisma (recommand√©) :</h5>
            <div class="code-example">
              <pre><code class="bash">npm install prisma @prisma/client
npx prisma init</code></pre>
            </div>
            
            <div class="code-example">
              <pre><code class="prisma"># schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Event {
  id                String   @id @default(uuid())
  title             String
  description       String?
  type              EventType
  startDate         DateTime @map("start_date")
  endDate           DateTime? @map("end_date")
  location          Json     // PostgreSQL JSON
  price             Float    @default(0)
  maxAttendees      Int?     @map("max_attendees")
  currentAttendees  Int      @default(0) @map("current_attendees")
  imageUrl          String?  @map("image_url")
  tags              String[]
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  creatorId         String   @map("creator_id")
  
  @@map("events")
}

enum EventType {
  CONCERT
  EXPOSITION
  CONFERENCE
  FESTIVAL
  SPORT
  AUTRE
}</code></pre>
            </div>
            
            <div class="code-example">
              <pre><code class="bash">npx prisma migrate dev --name init
npx prisma generate</code></pre>
            </div>
            
            <h5>Python - SQLAlchemy :</h5>
            <div class="code-example">
              <pre><code class="bash">pip install sqlalchemy psycopg2-binary alembic</code></pre>
            </div>
            
            <div class="code-example">
              <pre><code class="python"># models.py
from sqlalchemy import Column, String, DateTime, Float, Integer, JSON, ARRAY, Enum
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum

Base = declarative_base()

class EventType(enum.Enum):
    CONCERT = "concert"
    EXPOSITION = "exposition"
    CONFERENCE = "conference"
    FESTIVAL = "festival"
    SPORT = "sport"
    AUTRE = "autre"

class Event(Base):
    __tablename__ = "events"
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    title = Column(String(200), nullable=False)
    description = Column(String(2000))
    type = Column(Enum(EventType), nullable=False)
    start_date = Column(DateTime, nullable=False)
    end_date = Column(DateTime)
    location = Column(JSON, nullable=False)
    price = Column(Float, default=0)
    max_attendees = Column(Integer)
    current_attendees = Column(Integer, default=0)
    image_url = Column(String)
    tags = Column(ARRAY(String))
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    creator_id = Column(String, nullable=False)</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Pause -->
      <div class="pause-card">
        <h3>‚òï Pause (14h30-14h45) - 15 min</h3>
      </div>

      <!-- Phase 3: CRUD Complet & Validation -->
      <div class="phase-card">
        <div class="phase-header">
          <div class="phase-number">3</div>
          <div class="phase-info">
            <h3>üîß PHASE 3 : CRUD COMPLET & VALIDATION</h3>
            <p class="phase-duration">14h45-16h00 (75 min)</p>
          </div>
        </div>
        <div class="phase-content">
          <div class="phase-objectives">
            <h4>A. Impl√©mentation CRUD complet (45 min)</h4>
            
            <h5>GET /resources (liste pagin√©e) - Mise √† jour :</h5>
            <div class="code-example">
              <pre><code class="javascript">// Node.js avec Prisma
app.get('/api/v1/events', async (req, res) => {
  const page = parseInt(req.query.page) || 1;
  const limit = Math.min(parseInt(req.query.limit) || 20, 100);
  const offset = (page - 1) * limit;
  
  // Filtres
  const where = {};
  if (req.query.type) where.type = req.query.type;
  if (req.query.city) where.location = { path: ['city'], equals: req.query.city };
  if (req.query.date_from) where.startDate = { gte: new Date(req.query.date_from) };
  if (req.query.date_to) where.startDate = { ...where.startDate, lte: new Date(req.query.date_to) };
  
  // Tri
  const orderBy = {};
  if (req.query.sort) {
    const field = req.query.sort.replace('-', '');
    orderBy[field] = req.query.sort.startsWith('-') ? 'desc' : 'asc';
  } else {
    orderBy.startDate = 'asc';
  }
  
  try {
    const [events, total] = await Promise.all([
      prisma.event.findMany({
        where,
        orderBy,
        skip: offset,
        take: limit,
        include: {
          creator: {
            select: { id: true, name: true, email: true }
          }
        }
      }),
      prisma.event.count({ where })
    ]);
    
    res.json({
      data: events,
      meta: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit)
      },
      links: {
        self: `/events?page=${page}&limit=${limit}`,
        first: `/events?page=1&limit=${limit}`,
        last: `/events?page=${Math.ceil(total / limit)}&limit=${limit}`,
        next: page < Math.ceil(total / limit) ? `/events?page=${page + 1}&limit=${limit}` : null,
        prev: page > 1 ? `/events?page=${page - 1}&limit=${limit}` : null
      }
    });
  } catch (error) {
    console.error('Database error:', error);
    res.status(500).json({
      type: 'https://api.smartcity.local/errors/internal-error',
      title: 'Internal Server Error',
      status: 500,
      detail: 'Database operation failed',
      correlationId: req.correlationId
    });
  }
});</code></pre>
            </div>
            
            <h5>POST /resources (cr√©ation) - Nouveau :</h5>
            <div class="code-example">
              <pre><code class="javascript">// Validation avec Joi
const Joi = require('joi');

const eventSchema = Joi.object({
  title: Joi.string().min(3).max(200).required(),
  description: Joi.string().max(2000).optional(),
  type: Joi.string().valid('concert', 'exposition', 'conference', 'festival', 'sport', 'autre').required(),
  start_date: Joi.date().iso().greater('now').required(),
  end_date: Joi.date().iso().greater(Joi.ref('start_date')).optional(),
  location: Joi.object({
    name: Joi.string().required(),
    address: Joi.string().required(),
    city: Joi.string().required(),
    postal_code: Joi.string().pattern(/^\d{5}$/).optional(),
    coordinates: Joi.object({
      latitude: Joi.number().min(-90).max(90).optional(),
      longitude: Joi.number().min(-180).max(180).optional()
    }).optional()
  }).required(),
  price: Joi.number().min(0).default(0),
  max_attendees: Joi.number().integer().min(1).optional(),
  image_url: Joi.string().uri().optional(),
  tags: Joi.array().items(Joi.string()).default([])
});

app.post('/api/v1/events', authenticateToken, async (req, res) => {
  // Validation
  const { error, value } = eventSchema.validate(req.body);
  if (error) {
    return res.status(422).json({
      type: 'https://api.smartcity.local/errors/validation-error',
      title: 'Validation Failed',
      status: 422,
      detail: 'Invalid input data',
      errors: error.details.map(detail => ({
        field: detail.path.join('.'),
        code: detail.type,
        message: detail.message
      })),
      correlationId: req.correlationId
    });
  }
  
  try {
    const event = await prisma.event.create({
      data: {
        ...value,
        creatorId: req.user.id,
        startDate: new Date(value.start_date),
        endDate: value.end_date ? new Date(value.end_date) : null
      },
      include: {
        creator: {
          select: { id: true, name: true, email: true }
        }
      }
    });
    
    res.status(201)
       .header('Location', `/events/${event.id}`)
       .json(event);
  } catch (error) {
    console.error('Database error:', error);
    res.status(500).json({
      type: 'https://api.smartcity.local/errors/internal-error',
      title: 'Internal Server Error',
      status: 500,
      detail: 'Failed to create event',
      correlationId: req.correlationId
    });
  }
});</code></pre>
            </div>
          </div>
          
          <div class="phase-objectives">
            <h4>B. Tests d'int√©gration avec DB (30 min)</h4>
            
            <div class="code-example">
              <pre><code class="javascript">// tests/integration/events.test.js
const request = require('supertest');
const { PrismaClient } = require('@prisma/client');
const app = require('../../src/app');

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.TEST_DATABASE_URL || 'postgresql://user:password@localhost:5432/smartcity_test'
    }
  }
});

describe('Events API Integration Tests', () => {
  beforeEach(async () => {
    // Nettoyer la base de test
    await prisma.event.deleteMany();
    await prisma.user.deleteMany();
  });
  
  afterAll(async () => {
    await prisma.$disconnect();
  });
  
  describe('POST /api/v1/events', () => {
    it('should create a new event with valid data', async () => {
      // Cr√©er un utilisateur de test
      const user = await prisma.user.create({
        data: {
          email: 'test@example.com',
          name: 'Test User',
          password: 'hashedpassword'
        }
      });
      
      const eventData = {
        title: 'Test Concert',
        description: 'A test concert',
        type: 'concert',
        start_date: '2025-12-31T20:00:00Z',
        end_date: '2025-12-31T23:00:00Z',
        location: {
          name: 'Test Venue',
          address: '123 Test St',
          city: 'Test City'
        },
        price: 25.00,
        max_attendees: 100,
        tags: ['music', 'test']
      };
      
      const response = await request(app)
        .post('/api/v1/events')
        .set('Authorization', `Bearer ${generateTestToken(user.id)}`)
        .send(eventData)
        .expect(201);
      
      expect(response.body).toHaveProperty('id');
      expect(response.body.title).toBe(eventData.title);
      expect(response.body.type).toBe(eventData.type);
      expect(response.headers.location).toBe(`/events/${response.body.id}`);
      
      // V√©rifier en base
      const createdEvent = await prisma.event.findUnique({
        where: { id: response.body.id }
      });
      expect(createdEvent).toBeTruthy();
      expect(createdEvent.creatorId).toBe(user.id);
    });
  });
});</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase 4: √âquipe Auth - JWT R√©els -->
      <div class="phase-card">
        <div class="phase-header">
          <div class="phase-number">4</div>
          <div class="phase-info">
            <h3>üîê PHASE 4 : √âQUIPE AUTH - JWT R√âELS</h3>
            <p class="phase-duration">14h45-16h00 (Parallel)</p>
          </div>
        </div>
        <div class="phase-content">
          <p class="phase-note">Pendant que les autres √©quipes font le CRUD, l'√©quipe AUTH impl√©mente la vraie authentification</p>
          
          <div class="phase-objectives">
            <h4>A. Hash des mots de passe avec bcrypt (20 min)</h4>
            
            <div class="code-example">
              <pre><code class="bash">npm install bcryptjs
npm install --save-dev @types/bcryptjs</code></pre>
            </div>
            
            <div class="code-example">
              <pre><code class="javascript">// auth/utils.js
const bcrypt = require('bcryptjs');

const SALT_ROUNDS = 12; // Recommand√© pour 2024

async function hashPassword(password) {
  return await bcrypt.hash(password, SALT_ROUNDS);
}

async function verifyPassword(password, hashedPassword) {
  return await bcrypt.compare(password, hashedPassword);
}

module.exports = { hashPassword, verifyPassword };</code></pre>
            </div>
            
            <div class="code-example">
              <pre><code class="javascript">// routes/auth.js
const { hashPassword, verifyPassword } = require('../utils/auth');

router.post('/auth/register', async (req, res) => {
  const { email, password, name } = req.body;
  
  // Validation
  if (!email || !password || !name) {
    return problem422(req, res, "Email, password and name are required");
  }
  
  if (password.length < 8) {
    return problem422(req, res, "Password must be at least 8 characters long");
  }
  
  // V√©rifier si email existe d√©j√†
  const existingUser = await prisma.user.findUnique({
    where: { email }
  });
  
  if (existingUser) {
    return problem409(req, res, "Email already registered");
  }
  
  try {
    // Hash du mot de passe
    const hashedPassword = await hashPassword(password);
    
    // Cr√©er l'utilisateur
    const user = await prisma.user.create({
      data: {
        email,
        password: hashedPassword,
        name,
        role: 'user'
      },
      select: {
        id: true,
        email: true,
        name: true,
        role: true,
        createdAt: true
      }
    });
    
    res.status(201).json(user);
  } catch (error) {
    console.error('Registration error:', error);
    res.status(500).json({
      type: 'https://api.smartcity.local/errors/internal-error',
      title: 'Internal Server Error',
      status: 500,
      detail: 'Failed to create user account',
      correlationId: req.correlationId
    });
  }
});</code></pre>
            </div>
          </div>
          
          <div class="phase-objectives">
            <h4>B. Middleware d'authentification exportable (25 min)</h4>
            
            <div class="code-example">
              <pre><code class="javascript">// middleware/auth.js
const jwt = require('jsonwebtoken');
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  
  if (!token) {
    return res.status(401).json({
      type: 'https://api.smartcity.local/errors/unauthorized',
      title: 'Unauthorized',
      status: 401,
      detail: 'Access token required',
      correlationId: req.correlationId
    });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // Optionnel : v√©rifier que l'utilisateur existe encore
    const user = await prisma.user.findUnique({
      where: { id: decoded.sub },
      select: {
        id: true,
        email: true,
        name: true,
        role: true,
        isActive: true
      }
    });
    
    if (!user || !user.isActive) {
      return res.status(401).json({
        type: 'https://api.smartcity.local/errors/unauthorized',
        title: 'Unauthorized',
        status: 401,
        detail: 'User not found or inactive',
        correlationId: req.correlationId
      });
    }
    
    req.user = user;
    next();
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({
        type: 'https://api.smartcity.local/errors/unauthorized',
        title: 'Unauthorized',
        status: 401,
        detail: 'Token expired',
        correlationId: req.correlationId
      });
    }
    
    return res.status(401).json({
      type: 'https://api.smartcity.local/errors/unauthorized',
      title: 'Unauthorized',
      status: 401,
      detail: 'Invalid token',
      correlationId: req.correlationId
    });
  }
}

module.exports = {
  authenticateToken,
  authenticateOptional,
  requireRole
};</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase 5: Int√©gration Front -->
      <div class="phase-card">
        <div class="phase-header">
          <div class="phase-number">5</div>
          <div class="phase-info">
            <h3>üé® PHASE 5 : INT√âGRATION FRONT</h3>
            <p class="phase-duration">15h00-16h15 (Parallel)</p>
          </div>
        </div>
        <div class="phase-content">
          <p class="phase-note">Cette phase est sp√©cifique √† l'√©quipe FRONT</p>
          
          <div class="phase-objectives">
            <h4>A. Basculer vers les vrais services (30 min)</h4>
            
            <div class="code-example">
              <pre><code class="javascript">// front/src/config/api.js

const USE_MOCKS = process.env.REACT_APP_USE_MOCKS === 'true';

const API_BASE_URLS = {
  // URLs des vrais services
  events: USE_MOCKS ? 'http://localhost:4020' : 'http://localhost:3002/api/v1',
  transport: USE_MOCKS ? 'http://localhost:4030' : 'http://localhost:3003/api/v1',
  auth: USE_MOCKS ? 'http://localhost:4010' : 'http://localhost:3001/api/v1',
  // Ajoutez les autres services
};

export default API_BASE_URLS;</code></pre>
            </div>
            
            <div class="code-example">
              <pre><code class="javascript">// front/src/api/client.js
import API_BASE_URLS from '../config/api';

class ApiClient {
  constructor() {
    this.baseUrls = API_BASE_URLS;
    this.authToken = localStorage.getItem('authToken');
  }
  
  setAuthToken(token) {
    this.authToken = token;
    localStorage.setItem('authToken', token);
  }
  
  clearAuthToken() {
    this.authToken = null;
    localStorage.removeItem('authToken');
  }
  
  async request(service, endpoint, options = {}) {
    const baseUrl = this.baseUrls[service];
    const url = `${baseUrl}${endpoint}`;
    
    const headers = {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
      'X-Correlation-Id': this.generateUUID(),
      ...options.headers
    };
    
    // Ajouter le token d'authentification si disponible
    if (this.authToken) {
      headers['Authorization'] = `Bearer ${this.authToken}`;
    }
    
    const config = {
      method: options.method || 'GET',
      headers,
      ...options
    };
    
    if (options.body && typeof options.body === 'object') {
      config.body = JSON.stringify(options.body);
    }
    
    try {
      const response = await fetch(url, config);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new ApiError(errorData, response.status);
      }
      
      return await response.json();
    } catch (error) {
      if (error instanceof ApiError) {
        throw error;
      }
      throw new ApiError({ detail: 'Network error' }, 0);
    }
  }
  
  generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
}

class ApiError extends Error {
  constructor(problem, status) {
    super(problem.detail || 'API Error');
    this.problem = problem;
    this.status = status;
  }
}

export const apiClient = new ApiClient();
export { ApiError };</code></pre>
            </div>
          </div>
          
          <div class="phase-objectives">
            <h4>B. Formulaires de cr√©ation (POST) (30 min)</h4>
            
            <div class="code-example">
              <pre><code class="javascript">// front/src/components/EventForm.jsx
import React, { useState } from 'react';
import { apiClient } from '../api/client';

export function EventForm({ onEventCreated, onCancel }) {
  const [formData, setFormData] = useState({
    title: '',
    description: '',
    type: 'concert',
    start_date: '',
    end_date: '',
    location: {
      name: '',
      address: '',
      city: '',
      postal_code: ''
    },
    price: 0,
    max_attendees: '',
    image_url: '',
    tags: []
  });
  
  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const handleChange = (field, value) => {
    if (field.includes('.')) {
      const [parent, child] = field.split('.');
      setFormData(prev => ({
        ...prev,
        [parent]: {
          ...prev[parent],
          [child]: value
        }
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        [field]: value
      }));
    }
    
    // Effacer l'erreur du champ modifi√©
    if (errors[field]) {
      setErrors(prev => ({
        ...prev,
        [field]: null
      }));
    }
  };
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsSubmitting(true);
    setErrors({});
    
    try {
      // Pr√©parer les donn√©es
      const submitData = {
        ...formData,
        start_date: new Date(formData.start_date).toISOString(),
        end_date: formData.end_date ? new Date(formData.end_date).toISOString() : undefined,
        price: parseFloat(formData.price),
        max_attendees: formData.max_attendees ? parseInt(formData.max_attendees) : undefined,
        tags: formData.tags.filter(tag => tag.trim())
      };
      
      const event = await apiClient.request('events', '/events', {
        method: 'POST',
        body: submitData
      });
      
      onEventCreated(event);
    } catch (error) {
      if (error.status === 422 && error.problem.errors) {
        // Erreurs de validation
        const validationErrors = {};
        error.problem.errors.forEach(err => {
          validationErrors[err.field] = err.message;
        });
        setErrors(validationErrors);
      } else {
        // Erreur g√©n√©rale
        setErrors({ general: error.problem.detail || 'Erreur lors de la cr√©ation' });
      }
    } finally {
      setIsSubmitting(false);
    }
  };
  
  return (
    <form onSubmit={handleSubmit} className="event-form">
      <h2>Cr√©er un √©v√©nement</h2>
      
      {errors.general && (
        <div className="error-message">
          {errors.general}
        </div>
      )}
      
      <div className="form-group">
        <label htmlFor="title">Titre *</label>
        <input
          type="text"
          id="title"
          value={formData.title}
          onChange={(e) => handleChange('title', e.target.value)}
          className={errors.title ? 'error' : ''}
          required
        />
        {errors.title && <span className="error-text">{errors.title}</span>}
      </div>
      
      {/* Autres champs du formulaire... */}
      
      <div className="form-actions">
        <button type="button" onClick={onCancel} disabled={isSubmitting}>
          Annuler
        </button>
        <button type="submit" disabled={isSubmitting}>
          {isSubmitting ? 'Cr√©ation...' : 'Cr√©er l\'√©v√©nement'}
        </button>
      </div>
    </form>
  );
}</code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Phase 6: D√©mo & Synchronisation -->
      <div class="phase-card">
        <div class="phase-header">
          <div class="phase-number">6</div>
          <div class="phase-info">
            <h3>üé§ PHASE 6 : D√âMO & SYNCHRONISATION</h3>
            <p class="phase-duration">16h15-17h00 (45 min)</p>
          </div>
        </div>
        <div class="phase-content">
          <div class="phase-objectives">
            <h4>Format de d√©mo par √©quipe (5-6 min chacune)</h4>
            
            <h5>√âQUIPES BACK-END (sauf Auth)</h5>
            <ol>
              <li><strong>D√©mo live des endpoints CRUD (3 min)</strong></li>
              <li><strong>Montrer la base de donn√©es (1 min)</strong></li>
              <li><strong>Montrer les tests d'int√©gration (1 min)</strong></li>
              <li><strong>Montrer la validation (1 min)</strong></li>
            </ol>
            
            <h5>√âQUIPE AUTH</h5>
            <ol>
              <li><strong>D√©mo des endpoints d'authentification (3 min)</strong></li>
              <li><strong>Montrer le hash des mots de passe (1 min)</strong></li>
              <li><strong>D√©codage du JWT (1 min)</strong></li>
              <li><strong>Middleware d'authentification (1 min)</strong></li>
            </ol>
            
            <h5>√âQUIPE FRONT</h5>
            <ol>
              <li><strong>D√©mo de l'application avec vrais services (2 min)</strong></li>
              <li><strong>D√©mo des formulaires de cr√©ation (2 min)</strong></li>
              <li><strong>D√©mo de l'authentification (1 min)</strong></li>
              <li><strong>DevTools - Requ√™tes r√©elles (1 min)</strong></li>
            </ol>
          </div>
          
          <div class="phase-objectives">
            <h4>Discussion collective (15 min)</h4>
            <p>Points √† valider tous ensemble :</p>
            <ol>
              <li><strong>Compatibilit√© des contrats (5 min)</strong></li>
              <li><strong>Performance et stabilit√© (5 min)</strong></li>
              <li><strong>Pr√©paration J4 (5 min)</strong></li>
            </ol>
          </div>
        </div>
      </div>

      <!-- Checklist de fin de journ√©e -->
      <div class="checklist-section">
        <h3>‚úÖ CHECKLIST DE FIN DE JOURN√âE</h3>
        
        <div class="checklist-grid">
          <div class="checklist-card">
            <h4>√âquipes BACK v√©rifient :</h4>
            <ul>
              <li>‚úÖ Base de donn√©es install√©e et configur√©e</li>
              <li>‚úÖ Sch√©ma/migrations cr√©√©s et appliqu√©s</li>
              <li>‚úÖ Endpoints CRUD complets (GET, POST, PUT, PATCH, DELETE)</li>
              <li>‚úÖ Validation des donn√©es entrantes fonctionnelle</li>
              <li>‚úÖ Tests d'int√©gration avec DB qui passent</li>
              <li>‚úÖ Remplacement des tableaux en m√©moire par requ√™tes DB</li>
              <li>‚úÖ Gestion d'erreurs RFC 7807 maintenue</li>
              <li>‚úÖ Headers de corr√©lation propag√©s</li>
              <li>‚úÖ README mis √† jour avec instructions DB</li>
              <li>‚úÖ Au moins 3 commits Git aujourd'hui</li>
            </ul>
          </div>
          
          <div class="checklist-card">
            <h4>√âquipe AUTH v√©rifie :</h4>
            <ul>
              <li>‚úÖ Table users en base de donn√©es</li>
              <li>‚úÖ Hash bcrypt pour les mots de passe (work factor 12+)</li>
              <li>‚úÖ G√©n√©ration de vrais JWT sign√©s avec cl√© secr√®te</li>
              <li>‚úÖ V√©rification de tokens (middleware d'authentification)</li>
              <li>‚úÖ Tests avec utilisateurs r√©els en DB</li>
              <li>‚úÖ Middleware d'authentification exportable</li>
              <li>‚úÖ Endpoints register/login fonctionnels</li>
              <li>‚úÖ Gestion des refresh tokens</li>
              <li>‚úÖ Tests d'authentification complets</li>
              <li>‚úÖ Documentation du middleware</li>
            </ul>
          </div>
          
          <div class="checklist-card">
            <h4>√âquipe FRONT v√©rifie :</h4>
            <ul>
              <li>‚úÖ Configuration pour basculer mocks ‚Üî vrais services</li>
              <li>‚úÖ Formulaires de cr√©ation (POST) fonctionnels</li>
              <li>‚úÖ Gestion des erreurs de validation c√¥t√© UI</li>
              <li>‚úÖ Int√©gration avec Auth (login/register)</li>
              <li>‚úÖ Stockage du token (localStorage/sessionStorage)</li>
              <li>‚úÖ Affichage des donn√©es depuis la vraie DB</li>
              <li>‚úÖ Pagination c√¥t√© UI fonctionnelle</li>
              <li>‚úÖ Filtres et recherche fonctionnels</li>
              <li>‚úÖ Gestion des √©tats de chargement</li>
              <li>‚úÖ README avec instructions de configuration</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Pour demain -->
      <div class="next-day-section">
        <h3>üìö POUR DEMAIN (J4 Apr√®s-midi)</h3>
        
        <div class="next-day-content">
          <h4>Th√©orie du matin (J4)</h4>
          <ul>
            <li>S√©curit√© API avanc√©e : Rate limiting, CORS, headers de s√©curit√©</li>
            <li>RBAC (Role-Based Access Control) : Permissions granulaires</li>
            <li>Audit et logging : Tra√ßabilit√© des actions</li>
            <li>Bonnes pratiques de s√©curit√© en production</li>
          </ul>
          
          <h4>Pratique de l'apr√®s-midi (J4)</h4>
          <div class="team-next-goals">
            <h5>√âQUIPES BACK :</h5>
            <ul>
              <li>Impl√©menter rate limiting (express-rate-limit, redis)</li>
              <li>Configurer CORS correctement</li>
              <li>Ajouter headers de s√©curit√© (helmet)</li>
              <li>Impl√©menter RBAC avec permissions granulaires</li>
              <li>Ajouter audit logging (qui fait quoi, quand)</li>
              <li>Tests de s√©curit√© basiques</li>
            </ul>
            
            <h5>√âQUIPE AUTH :</h5>
            <ul>
              <li>Impl√©menter refresh token rotation</li>
              <li>Ajouter rate limiting sur les endpoints d'auth</li>
              <li>Audit des tentatives de connexion</li>
              <li>Gestion des sessions et d√©connexion</li>
              <li>Middleware RBAC avanc√©</li>
            </ul>
            
            <h5>√âQUIPE FRONT :</h5>
            <ul>
              <li>Gestion des tokens expir√©s (refresh automatique)</li>
              <li>Gestion des erreurs de s√©curit√©</li>
              <li>Interface d'administration (pour les admins)</li>
              <li>Am√©lioration de l'UX de s√©curit√©</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Progression globale -->
      <div class="progress-section">
        <h3>üìà PROGRESSION GLOBALE</h3>
        <div class="progress-timeline">
          <div class="progress-step completed">
            <div class="step-icon">‚úÖ</div>
            <div class="step-info">
              <h4>J1 PM</h4>
              <p>Contrat OpenAPI + Structure projet</p>
            </div>
          </div>
          
          <div class="progress-step completed">
            <div class="step-icon">‚úÖ</div>
            <div class="step-info">
              <h4>J2 PM</h4>
              <p>Endpoints mock + Tests + Prism</p>
            </div>
          </div>
          
          <div class="progress-step current">
            <div class="step-icon">üîÑ</div>
            <div class="step-info">
              <h4>J3 PM</h4>
              <p>Base de donn√©es + CRUD complet + JWT r√©els</p>
            </div>
          </div>
          
          <div class="progress-step pending">
            <div class="step-icon">‚è≥</div>
            <div class="step-info">
              <h4>J4 PM</h4>
              <p>S√©curit√© avanc√©e + RBAC + Audit</p>
            </div>
          </div>
          
          <div class="progress-step pending">
            <div class="step-icon">‚è≥</div>
            <div class="step-info">
              <h4>J5 PM</h4>
              <p>Int√©gration externe + R√©silience + Communication</p>
            </div>
          </div>
          
          <div class="progress-step pending">
            <div class="step-icon">‚è≥</div>
            <div class="step-info">
              <h4>J6 PM</h4>
              <p>API Gateway + Architecture distribu√©e</p>
            </div>
          </div>
          
          <div class="progress-step pending">
            <div class="step-icon">‚è≥</div>
            <div class="step-info">
              <h4>J7 PM</h4>
              <p>Performance + Tests de charge + Observabilit√©</p>
            </div>
          </div>
          
          <div class="progress-step pending">
            <div class="step-icon">‚è≥</div>
            <div class="step-info">
              <h4>J8 PM</h4>
              <p>Containerisation + CI/CD + Finalisation</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Retour d'exp√©rience -->
      <div class="feedback-section">
        <h3>üí° RETOUR D'EXP√âRIENCE DE L'ENSEIGNANT</h3>
        
        <div class="feedback-grid">
          <div class="feedback-card positive">
            <h4>Ce qui a bien march√© aujourd'hui</h4>
            <ul>
              <li>‚úÖ Les √©quipes qui ont pr√©par√© leur configuration DB en avance</li>
              <li>‚úÖ L'utilisation d'ORMs/ODMs pour simplifier les requ√™tes</li>
              <li>‚úÖ Les tests d'int√©gration √©crits en parall√®le du code</li>
              <li>‚úÖ La coordination Auth ‚Üî autres services sur le middleware</li>
            </ul>
          </div>
          
          <div class="feedback-card attention">
            <h4>Points d'attention pour la suite</h4>
            <ul>
              <li>‚ö†Ô∏è Ne pas sous-estimer J4 : La s√©curit√© prend du temps, pr√©voyez des marges</li>
              <li>‚ö†Ô∏è Commiter souvent : 4-5 commits minimum par demi-journ√©e</li>
              <li>‚ö†Ô∏è Documenter les migrations : Tr√®s important pour la production</li>
              <li>‚ö†Ô∏è Tester avec des donn√©es r√©alistes : Au moins 50-100 items pour tester les performances</li>
            </ul>
          </div>
          
          <div class="feedback-card advice">
            <h4>Conseils pour J4</h4>
            <ul>
              <li>Commencez par les headers de s√©curit√© (helmet), c'est le plus simple</li>
              <li>Rate limiting : commencez par des valeurs conservatrices</li>
              <li>RBAC : commencez simple (user/admin), vous pourrez complexifier</li>
              <li>Audit : loggez au minimum les actions sensibles (cr√©ation, modification, suppression)</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="footer-logo">
            <img src="../assets/logo.jpeg" alt="YNOV Campus" class="footer-logo-img">
            <span class="footer-logo-text">Web Services</span>
          </div>
          <p class="footer-description">Jour 3 ‚Äî Fil Rouge : API REST Avanc√©.</p>
        </div>
        <div class="footer-section">
          <h3>Navigation</h3>
          <ul>
            <li><a href="../index.html">Accueil</a></li>
            <li><a href="day1.html">Jour 1 - Th√©orie</a></li>
            <li><a href="day2.html">Jour 2 - Th√©orie</a></li>
            <li><a href="day3.html">Jour 3 - Th√©orie</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Fil Rouge</h3>
          <ul>
            <li><a href="day1FilRouge.html">Fil Rouge J1</a></li>
            <li><a href="day2FilRouge.html">Fil Rouge J2</a></li>
            <li><a href="day3FilRouge.html">Fil Rouge J3</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Contact</h3>
          <p>Formation Web Services</p>
          <p>YNOV Campus</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 YNOV Campus. Tous droits reserves.</p>
      </div>
    </div>
  </footer>

<script src="../script.js"></script>
  
  <!-- highlight.js pour la coloration syntaxique -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      hljs.highlightAll();
    });
  </script>
</body>
</html>
